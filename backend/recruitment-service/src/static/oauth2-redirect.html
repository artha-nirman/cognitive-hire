<!doctype html>
<html lang="en-US">
<head>
    <title>Swagger UI: OAuth2 Redirect</title>
    <meta charset="UTF-8">
</head>
<body>
<script>
    'use strict';
    
    // Debug function - uncomment to enable console logging
    function debugLog(obj) {
        console.log(obj);
    }

    // Parse a query string into an object
    function parseQueryString(string) {
        if (string === "") return {};
        
        const segments = string.split("&").map(s => s.split("=").map(decodeURIComponent));
        const queryParams = {};
        segments.forEach(segment => {
            if (segment[0]) {
                queryParams[segment[0]] = segment[1] || "";
            }
        });
        return queryParams;
    }

    // Handle OAuth2 redirect
    function run() {
        const oauth2 = window.opener.swaggerUIRedirectOauth2;
        const sentState = oauth2.state;
        
        debugLog("Starting OAuth2 redirect handler");
        debugLog("URL: " + window.location.href);
        
        // Parse query params from search and hash portions of URL
        const queryParams = {
            ...parseQueryString(window.location.search.substring(1)),
            ...parseQueryString(window.location.hash.substring(1))
        };
        
        debugLog("Parsed params:");
        debugLog(queryParams);

        // Check for error
        if (queryParams.error) {
            oauth2.error = queryParams.error;
            if (queryParams.error_description) oauth2.errorDescription = queryParams.error_description;
            debugLog("Error from auth service: " + queryParams.error);
            window.close();
            return;
        }
        
        // Check state for CSRF protection
        if (!queryParams.state || queryParams.state !== sentState) {
            debugLog("OAuth state mismatch: " + queryParams.state + " != " + sentState);
            oauth2.error = "OAuth security error";
            oauth2.errorDescription = "State mismatch";
            window.close();
            return;
        }

        // Handle authorization code
        if (queryParams.code) {
            debugLog("Received authorization code");
            oauth2.code = queryParams.code;
            window.close();
            return;
        }

        // Handle access token (implicit flow)
        if (queryParams.access_token) {
            debugLog("Received access token");
            oauth2.accessToken = queryParams.access_token;
            oauth2.tokenType = queryParams.token_type;
            oauth2.expiresIn = queryParams.expires_in;
            if (queryParams.scope) oauth2.scopes = queryParams.scope.split(" ");
            window.close();
            return;
        }
        
        // Handle ID token
        if (queryParams.id_token) {
            debugLog("Received ID token");
            oauth2.idToken = queryParams.id_token;
            if (queryParams.token_type) oauth2.tokenType = queryParams.token_type || "Bearer";
            window.close();
            return;
        }

        debugLog("No token or code received!");
        oauth2.error = "No authorization code or token received";
        window.close();
    }

    window.addEventListener('DOMContentLoaded', function() {
        run();
    });
</script>
</body>
</html>
