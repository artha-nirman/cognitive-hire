<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Azure AD B2C Token Debug Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        pre {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow: auto;
            max-height: 400px;
        }
        button {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #106ebe;
        }
        .result {
            margin-top: 20px;
        }
        .token-info {
            margin-top: 10px;
        }
        .error {
            color: #d83b01;
            background-color: #fff4f4;
            padding: 10px;
            border-left: 3px solid #d83b01;
            margin: 10px 0;
        }
        .success {
            color: #107C10;
            background-color: #f2fff2;
            padding: 10px;
            border-left: 3px solid #107C10;
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Azure AD B2C Token Debug Tool</h1>
    
    <p>This tool helps test Azure AD B2C authentication and troubleshoot token flows.</p>
    
    <div class="form-group">
        <label for="tenantName">Tenant Name:</label>
        <input type="text" id="tenantName" placeholder="e.g. cognitivehire" value="cognitivehire">
    </div>
    
    <div class="form-group">
        <label for="clientId">Client ID:</label>
        <input type="text" id="clientId" placeholder="Your Azure AD B2C client ID">
    </div>
    
    <div class="form-group">
        <label for="policy">Policy:</label>
        <input type="text" id="policy" placeholder="e.g. B2C_1_signupsignin1" value="B2C_1_signupsignin1">
    </div>
    
    <div class="form-group">
        <label for="scope">Scope:</label>
        <input type="text" id="scope" placeholder="e.g. https://cognitivehire.onmicrosoft.com/api/user_impersonation">
    </div>
    
    <div>
        <button id="login">Login with Azure AD B2C</button>
        <button id="callApi" disabled>Call API</button>
        <button id="clearToken">Clear Token</button>
        <button id="buildUrl">Build URL Only</button>
    </div>
    
    <div id="statusMessage"></div>
    
    <div class="result">
        <h3>Generated URL</h3>
        <pre id="generatedUrl">No URL generated yet</pre>
        
        <h3>Token</h3>
        <pre id="token">No token available</pre>
        
        <h3>Token Information</h3>
        <pre id="tokenInfo">No token information</pre>
        
        <h3>API Response</h3>
        <pre id="apiResponse">No API response</pre>
    </div>

    <script>
        // DOM elements
        const tenantNameInput = document.getElementById('tenantName');
        const clientIdInput = document.getElementById('clientId');
        const policyInput = document.getElementById('policy');
        const scopeInput = document.getElementById('scope');
        const loginBtn = document.getElementById('login');
        const callApiBtn = document.getElementById('callApi');
        const clearTokenBtn = document.getElementById('clearToken');
        const buildUrlBtn = document.getElementById('buildUrl');
        const tokenElement = document.getElementById('token');
        const tokenInfoElement = document.getElementById('tokenInfo');
        const apiResponseElement = document.getElementById('apiResponse');
        const generatedUrlElement = document.getElementById('generatedUrl');
        const statusMessageElement = document.getElementById('statusMessage');
        
        // Set default scope based on tenant input
        tenantNameInput.addEventListener('input', updateScope);
        clientIdInput.addEventListener('input', updateScope);
        
        function updateScope() {
            const tenant = tenantNameInput.value;
            const clientId = clientIdInput.value;
            if (tenant && clientId && scopeInput.value === '') {
                scopeInput.value = `https://${tenant}.onmicrosoft.com/${clientId}/user_impersonation`;
            }
        }
        
        // Show status message
        function showStatus(message, isError = false) {
            statusMessageElement.innerHTML = message;
            statusMessageElement.className = isError ? 'error' : 'success';
            setTimeout(() => {
                statusMessageElement.innerHTML = '';
                statusMessageElement.className = '';
            }, 5000);
        }
        
        // Build the authorization URL
        function buildAuthUrl() {
            const tenant = tenantNameInput.value;
            const clientId = clientIdInput.value;
            const policy = policyInput.value;
            const scope = scopeInput.value;
            
            if (!tenant || !clientId || !policy || !scope) {
                showStatus('Please fill in all fields', true);
                return null;
            }
            
            // Use the real redirect URI from the current page
            const redirectUri = `${window.location.origin}/static/token-debug.html`;
            
            // Generate a random state parameter
            const state = btoa(new Date().toString());
            
            // Build authorization URL with PKCE support
            const authUrl = `https://${tenant}.b2clogin.com/${tenant}.onmicrosoft.com/${policy}/oauth2/v2.0/authorize` +
                `?client_id=${encodeURIComponent(clientId)}` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&response_mode=query` +
                `&scope=${encodeURIComponent(scope)}` +
                `&state=${encodeURIComponent(state)}`;
            
            generatedUrlElement.innerText = authUrl;
            return authUrl;
        }
        
        // Login with Azure AD B2C
        function login() {
            const authUrl = buildAuthUrl();
            if (authUrl) {
                // Redirect to login
                window.location.href = authUrl;
            }
        }
        
        // Call API with token
        async function callApi() {
            const token = localStorage.getItem('accessToken');
            
            if (!token) {
                showStatus('No token available. Please login first.', true);
                return;
            }
            
            try {
                const response = await fetch('/api/employer/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                    apiResponseElement.innerText = JSON.stringify(responseData, null, 2);
                } catch (e) {
                    // Not JSON, just show text
                    apiResponseElement.innerText = responseText;
                }
                
                if (!response.ok) {
                    showStatus(`API call failed: ${response.status} ${response.statusText}`, true);
                } else {
                    showStatus('API call successful');
                }
            } catch (error) {
                apiResponseElement.innerText = `Error calling API: ${error.message}`;
                showStatus(`Error: ${error.message}`, true);
            }
        }
        
        // Clear token
        function clearToken() {
            localStorage.removeItem('accessToken');
            tokenElement.innerText = "No token available";
            tokenInfoElement.innerText = "No token information";
            apiResponseElement.innerText = "No API response";
            callApiBtn.disabled = true;
            showStatus('Token cleared');
        }
        
        // Display decoded token info
        function displayTokenInfo(token) {
            try {
                // Decode JWT (just for display, no signature verification)
                const parts = token.split('.');
                if (parts.length !== 3) {
                    tokenInfoElement.innerText = "Invalid token format";
                    return;
                }
                
                const base64Url = parts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                const payload = JSON.parse(jsonPayload);
                tokenInfoElement.innerText = JSON.stringify(payload, null, 2);
                
                // Check token expiration
                if (payload.exp) {
                    const expDate = new Date(payload.exp * 1000);
                    const now = new Date();
                    if (expDate < now) {
                        showStatus('Warning: Token has expired!', true);
                    } else {
                        const timeRemaining = Math.floor((expDate - now) / 1000 / 60);
                        showStatus(`Token valid for ${timeRemaining} more minutes`);
                    }
                }
                
                return payload;
            } catch (error) {
                tokenInfoElement.innerText = `Error decoding token: ${error.message}`;
                showStatus(`Error decoding token: ${error.message}`, true);
                return null;
            }
        }
        
        // Check for auth response on page load
        function checkForAuthResponse() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');
            const error_description = urlParams.get('error_description');
            
            if (error) {
                showStatus(`Authentication error: ${error} - ${error_description || 'No description'}`, true);
                return;
            }
            
            if (code) {
                showStatus(`Authorization code received. Exchanging for token...`);
                
                // Clear the URL without reloading the page
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Mock token exchange - in a real app, we would call the token endpoint
                // This is just for demonstration purposes
                const mockToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjI1MTYyMzkwMjIsInJvbGVzIjpbImFkbWluIl0sInRlbmFudF9pZCI6InRlc3QtdGVuYW50In0.2HlCqzBXnR5GHoDA8zasjDKOWjkCBFuyzlHLXGWx5t8";
                
                // Store token in localStorage
                localStorage.setItem('accessToken', mockToken);
                
                // Display token
                tokenElement.innerText = mockToken;
                
                // Parse and display token info
                displayTokenInfo(mockToken);
                
                // Enable API call button
                callApiBtn.disabled = false;
                
                showStatus('Mock token generated for demonstration. In a real app, this would exchange the code for a token.');
            }
        }
        
        // Check for existing token
        function checkForExistingToken() {
            const token = localStorage.getItem('accessToken');
            if (token) {
                tokenElement.innerText = token;
                displayTokenInfo(token);
                callApiBtn.disabled = false;
                showStatus('Loaded existing token from storage');
            }
        }
        
        // Set up event handlers
        loginBtn.addEventListener('click', login);
        callApiBtn.addEventListener('click', callApi);
        clearTokenBtn.addEventListener('click', clearToken);
        buildUrlBtn.addEventListener('click', buildAuthUrl);
        
        // Initialize
        window.onload = function() {
            // Check for auth response first
            checkForAuthResponse();
            
            // Then check for existing token
            checkForExistingToken();
            
            // Initialize scope if possible
            updateScope();
        };
    </script>
</body>
</html>
